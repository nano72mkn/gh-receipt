#!/usr/bin/env bash
set -e

# ãƒ˜ãƒ«ãƒ—è¡¨ç¤º
show_help() {
    cat << EOF
Usage: gh-receipt [USERNAME] [OPTIONS]

GitHub ã®æ´»å‹•ãƒ¬ã‚·ãƒ¼ãƒˆã‚’ç¾ã—ãè¡¨ç¤ºã—ã¾ã™

Options:
  -h, --help      ã“ã®ãƒ˜ãƒ«ãƒ—ã‚’è¡¨ç¤º
  -d, --days N    éå»Næ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º (ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 30)
  -w, --weekly    éå»7æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  -m, --monthly   éå»30æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
  -y, --yearly    éå»365æ—¥é–“ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º

Examples:
  gh-receipt                    # è‡ªåˆ†ã®éå»30æ—¥é–“ã®æ´»å‹•
  gh-receipt nano72mkn          # ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»30æ—¥é–“
  gh-receipt -w                 # è‡ªåˆ†ã®éå»7æ—¥é–“
  gh-receipt nano72mkn --weekly # ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»7æ—¥é–“
  gh-receipt nano72mkn -d 90    # ç‰¹å®šãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éå»90æ—¥é–“
EOF
}

# ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
USERNAME=""
DAYS=30

# å¼•æ•°è§£æ
while [[ $# -gt 0 ]]; do
    case $1 in
        -h|--help)
            show_help
            exit 0
            ;;
        -w|--weekly)
            DAYS=7
            shift
            ;;
        -m|--monthly)
            DAYS=30
            shift
            ;;
        -y|--yearly)
            DAYS=365
            shift
            ;;
        -d|--days)
            DAYS="$2"
            shift 2
            ;;
        -*)
            echo "ã‚¨ãƒ©ãƒ¼: ä¸æ˜ãªã‚ªãƒ—ã‚·ãƒ§ãƒ³: $1"
            echo "è©³ç´°ã¯ gh-receipt --help ã‚’å‚ç…§ã—ã¦ãã ã•ã„"
            exit 1
            ;;
        *)
            if [ -z "$USERNAME" ]; then
                USERNAME="$1"
            fi
            shift
            ;;
    esac
done

# ãƒ¦ãƒ¼ã‚¶ãƒ¼åãŒæŒ‡å®šã•ã‚Œã¦ã„ãªã„å ´åˆã¯ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ä½¿ç”¨
if [ -z "$USERNAME" ]; then
    USERNAME=$(gh api user -q .login 2>/dev/null || echo "")
    if [ -z "$USERNAME" ]; then
        echo "ã‚¨ãƒ©ãƒ¼: ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’æŒ‡å®šã™ã‚‹ã‹ã€gh auth login ã§ãƒ­ã‚°ã‚¤ãƒ³ã—ã¦ãã ã•ã„"
        exit 1
    fi
fi

# è‰²ã®å®šç¾©
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[0;33m'
CYAN='\033[0;36m'
MAGENTA='\033[0;35m'
GRAY='\033[0;90m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# æ—¥ä»˜è¨ˆç®—ï¼ˆmacOS ã¨ Linux ã®ä¸¡æ–¹ã«å¯¾å¿œï¼‰
if date -v -1d >/dev/null 2>&1; then
    # macOS
    FROM_DATE=$(date -v-${DAYS}d -u +%Y-%m-%dT%H:%M:%SZ)
    TODAY=$(date +%Y-%m-%d)
else
    # Linux
    FROM_DATE=$(date -u -d "${DAYS} days ago" +%Y-%m-%dT%H:%M:%SZ)
    TODAY=$(date +%Y-%m-%d)
fi

echo -e "${BLUE}${BOLD}ğŸ“Š æ´»å‹•ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...${NC}"

# è‡ªåˆ†ã®ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‹ãƒã‚§ãƒƒã‚¯
CURRENT_USER=$(gh api user -q .login 2>/dev/null || echo "")
IS_SELF=false
if [ "$USERNAME" = "$CURRENT_USER" ]; then
    IS_SELF=true
fi

# GraphQL ã‚¯ã‚¨ãƒªã§ãƒ‡ãƒ¼ã‚¿å–å¾—
RESPONSE=$(gh api graphql -f query='
  query($username: String!, $from: DateTime!, $to: DateTime!) {
    user(login: $username) {
      contributionsCollection(from: $from, to: $to) {
        totalCommitContributions
        totalPullRequestContributions
        totalPullRequestReviewContributions
        totalIssueContributions
        restrictedContributionsCount
        contributionCalendar {
          totalContributions
          weeks {
            contributionDays {
              date
              contributionCount
            }
          }
        }
      }
    }
  }
' -f username="$USERNAME" -f from="$FROM_DATE" -f to="${TODAY}T23:59:59Z" 2>/dev/null) || {
    echo -e "${RED}ã‚¨ãƒ©ãƒ¼: ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ${NC}"
    exit 1
}

# ãƒ‡ãƒ¼ã‚¿è§£æ
PUBLIC_COMMITS=$(echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.totalCommitContributions')
PUBLIC_PRS=$(echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.totalPullRequestContributions')
PUBLIC_REVIEWS=$(echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.totalPullRequestReviewContributions')
PUBLIC_ISSUES=$(echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.totalIssueContributions')
PRIVATE_TOTAL=$(echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.restrictedContributionsCount // 0')
TOTAL_CONTRIBUTIONS=$(echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.contributionCalendar.totalContributions')

# å®Ÿéš›ã®åˆè¨ˆã‚’è¨ˆç®—
TOTAL_COMMITS=$((PUBLIC_COMMITS + PRIVATE_TOTAL))
TOTAL_PUBLIC=$((PUBLIC_COMMITS + PUBLIC_PRS + PUBLIC_REVIEWS + PUBLIC_ISSUES))

# æœŸé–“ã®è¡¨ç¤ºæ–‡å­—åˆ—
case $DAYS in
    7)  PERIOD_TEXT="Weekly" ;;
    30) PERIOD_TEXT="Monthly" ;;
    365) PERIOD_TEXT="Yearly" ;;
    *)  PERIOD_TEXT="Last ${DAYS} days" ;;
esac

# ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
echo
echo -e "${BLUE}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${BLUE}${BOLD}       ğŸ§¾ GitHub Activity Receipt${NC}"
echo -e "${GRAY}              ${PERIOD_TEXT}${NC}"
echo -e "${BLUE}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"

# çµ±è¨ˆè¡¨ç¤ºï¼ˆSNSç”¨ã«ã‚·ãƒ³ãƒ—ãƒ«ã«ï¼‰
echo
echo -e "${GREEN}${BOLD}ğŸ“ˆ Activity Summary${NC}"
echo
echo -e "  ${MAGENTA}${BOLD}Total Contributions${NC}"
echo -e "  ${YELLOW}${BOLD}${TOTAL_CONTRIBUTIONS}${NC} activities"
echo
echo -e "  ${CYAN}${BOLD}Breakdown${NC}"
echo -e "  â”œâ”€ Commits (Public):     ${GREEN}${PUBLIC_COMMITS}${NC}"
echo -e "  â”œâ”€ Commits (Private):    ${GREEN}${PRIVATE_TOTAL}${NC}"
echo -e "  â”œâ”€ Pull Requests:        ${GREEN}${PUBLIC_PRS}${NC}"
echo -e "  â”œâ”€ Code Reviews:         ${GREEN}${PUBLIC_REVIEWS}${NC}"
echo -e "  â””â”€ Issues:               ${GREEN}${PUBLIC_ISSUES}${NC}"

# é€±é–“ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãªã‚°ãƒ©ãƒ•ï¼‰
echo
echo -e "${CYAN}${BOLD}ğŸ“… Daily Activity${NC}"
echo

# è¡¨ç¤ºã™ã‚‹æ—¥æ•°ã‚’èª¿æ•´ï¼ˆæœ€å¤§7æ—¥ï¼‰
DISPLAY_DAYS=$((DAYS > 7 ? 7 : DAYS))

# æœ€å¾Œã®é€±ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤º
echo "$RESPONSE" | jq -r '.data.user.contributionsCollection.contributionCalendar.weeks[-1].contributionDays[] | 
  "\(.date)|\(.contributionCount)"' | tail -${DISPLAY_DAYS} | {
    max_count=0
    data=""
    while IFS='|' read -r date count; do
        if [ "$count" -gt "$max_count" ]; then
            max_count=$count
        fi
        data="${data}${date}|${count}\n"
    done
    
    # ã‚°ãƒ©ãƒ•ã®ã‚¹ã‚±ãƒ¼ãƒ«èª¿æ•´
    scale=1
    if [ "$max_count" -gt 15 ]; then
        scale=$((max_count / 15 + 1))
    fi
    
    echo -e "$data" | while IFS='|' read -r date count; do
        if [ -n "$date" ]; then
            # æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
            day_name=$(date -j -f "%Y-%m-%d" "$date" "+%a" 2>/dev/null || date -d "$date" "+%a")
            
            # ãƒãƒ¼ä½œæˆ
            if [ "$count" -gt 0 ]; then
                bar_length=$((count / scale))
                [ "$bar_length" -eq 0 ] && bar_length=1
                bar=$(printf 'â–“%.0s' $(seq 1 $bar_length))
                bar_color="${GREEN}"
            else
                bar="â–‘"
                bar_color="${GRAY}"
            fi
            
            # ä»Šæ—¥ã¯å¼·èª¿
            if [ "$date" = "$TODAY" ]; then
                printf "  ${YELLOW}${BOLD}%-3s${NC} ${bar_color}%-15s${NC} ${BOLD}%2d${NC}\n" "$day_name" "$bar" "$count"
            else
                printf "  %-3s ${bar_color}%-15s${NC} %2d\n" "$day_name" "$bar" "$count"
            fi
        fi
    done
}

# ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
echo
if [ "$TOTAL_CONTRIBUTIONS" -gt 100 ]; then
    echo -e "${YELLOW}${BOLD}ğŸ”¥ Amazing work! Keep it up!${NC}"
elif [ "$TOTAL_CONTRIBUTIONS" -gt 50 ]; then
    echo -e "${GREEN}${BOLD}âœ¨ Great progress!${NC}"
elif [ "$TOTAL_CONTRIBUTIONS" -gt 10 ]; then
    echo -e "${CYAN}${BOLD}ğŸ‘ Nice activity!${NC}"
else
    echo -e "${MAGENTA}${BOLD}ğŸŒ± Every contribution counts!${NC}"
fi

echo -e "${BLUE}${BOLD}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"